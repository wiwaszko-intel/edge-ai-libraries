name: SIV Weekly Build Tagging

on:
  schedule:
    - cron: '0 15 * * 2'  # Every Tuesday at 15:00 UTC
  workflow_dispatch:

permissions: {}

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Get latest commit SHA
      id: get-sha
      run: |
        echo "üîç Getting latest commit SHA from main branch..."
        
        RESPONSE=$(curl -s -w "%{http_code}" -o commit.json \
          -H "Authorization: Bearer ${{ secrets.SIV_USER_TOKEN_GH }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.repository }}/commits/main)
        
        HTTP_CODE="${RESPONSE: -3}"
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          COMMIT_SHA=$(jq -r '.sha' commit.json)
          echo "‚úÖ Successfully retrieved commit SHA: $COMMIT_SHA"
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Failed to get commit SHA. HTTP Code: $HTTP_CODE"
          echo "Response:"
          cat commit.json
          exit 1
        fi

    - name: Create lightweight tag via API
      run: |
        TAG_NAME="${{ vars.SIV_WEEKLY_BUILD_PREFIX }}-$(date +'%Y%m%d')"
        COMMIT_SHA="${{ steps.get-sha.outputs.sha }}"
        
        echo "üöÄ Creating tag: $TAG_NAME"
        echo "üìç Target commit: $COMMIT_SHA"
        
        if [ "$COMMIT_SHA" = "" ] || [ "$COMMIT_SHA" = "null" ]; then
          echo "‚ùå Invalid commit SHA: $COMMIT_SHA"
          exit 1
        fi
        
        RESPONSE=$(curl -s -w "%{http_code}" -o tag.json \
          -H "Authorization: Bearer ${{ secrets.SIV_USER_TOKEN_GH }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          -X POST \
          https://api.github.com/repos/${{ github.repository }}/git/refs \
          -d "{
            \"ref\": \"refs/tags/${TAG_NAME}\",
            \"sha\": \"${COMMIT_SHA}\"
          }")
        
        HTTP_CODE="${RESPONSE: -3}"
        
        if [ "$HTTP_CODE" -eq 201 ]; then
          printf "\n"
          printf "‚úÖ Weekly Build Tag Created Successfully!\n"
          printf "==========================================\n"
          printf "üìå Tag Name:     %s\n" "${TAG_NAME}"
          printf "üîó Commit SHA:   %s\n" "${COMMIT_SHA}"
          printf "üìÅ Repository:   %s\n" "${{ github.repository }}"
          printf "‚è∞ Created:      %s\n" "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          printf "üåê View Online:  https://github.com/%s/releases/tag/%s\n" "${{ github.repository }}" "${TAG_NAME}"
          printf "\n"
          echo "üìã API Response:"
          cat tag.json | jq '.'
        else
          printf "\n"
          printf "‚ùå Failed to create tag!\n"
          printf "========================\n"
          printf "HTTP Code: %s\n" "$HTTP_CODE"
          printf "Response:\n"
          cat tag.json
          printf "\n"
          exit 1
        fi
